<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>Conflict viewer test</title>
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width">
	
	<link rel="stylesheet" href="css/normalize.css">
	<link rel="stylesheet" href="css/styles_d3Force.css">
	<script src="jslib/jquery-1.9.1.js"></script>
	<script src="jslib/d3.v3.min.js"></script>
	<script src="jslib/mustache.js"></script>
	<script type="text/javascript" src="templates/mTemps.js"></script>
	
<script type="text/javascript">
$(function(){

confURLs = {
	"Prisoners":"json/networkfor_Prisoners.json",
	"Garrison" :"json/networkfor_Garrison.json",
	"SyriaIraq":"json/networkfor_SyriaIraq.json"
};

var vis = d3.select("svg.layout.force")

var nodes = [],
    links = [];

var force = d3.layout.force()
    .nodes(nodes)
    .links(links)
    .charge(-1000)
    .linkDistance(80)
    .size([1200,800])
    .on("tick", tick);

var node = vis.selectAll(".node"),
	link = vis.selectAll(".link"),
	label = vis.selectAll(".label");
	
var loadConflict = function(confURL){
	nodes.length=0;
	links.length=0;
	$.getJSON(confURL,function(data){
		$.each(data.nodes, function(i,a){
			a.reachable = $.map(a.reachable,function(b){
						b.source = a;
						b.target = data.nodes[b.target];
						return(b)
			});
			Array.prototype.push.apply(links,a.reachable);
		});
		$.extend(nodes,d3.values(data.nodes));
		
		$(".stateBar").html(
			$.map(data.nodes,function(a){
				return Mustache.render(templates.stateListTemplate,a);
			})
		);
		
		start();
	});
};

loadConflict("json/networkfor_Prisoners.json");

function start() {
	link = link.data(force.links(), function(d) { return d.source.id + "-" + d.target.id; });
	link.enter()
		.insert("line", ".node")
		.attr("class", function(d) { return "link " + d.dm; })
		.attr("marker-end","url(#arrow-head)");
	link.exit().remove();

	node = node.data(force.nodes(), function(d) { return d.id;});
	node.enter()
		.append("circle")
		.attr("class", function(d) { return "node st" + d.id; })
		.attr("r", 10)
		.call(force.drag)
		.on("mouseover",function(){
			d3.selectAll("circle."+this.classList[1])
				.style("fill","paleVioletRed");
			d3.select(this)
				.style("stroke-width","2px")
		})
		.on("mouseout",function(){
			d3.selectAll("circle."+this.classList[1])
				.style("stroke-width","1.5px")
				.style("fill","lightBlue");
		});
	node.exit().remove();
	
	label = label.data(force.nodes(), function(d) { return d.id;});
	label.enter()
		.append("text")
		.attr("class", "label")
		.attr("dy",3)
		.text(function(d){return d.id});
	label.exit().remove();
	
	d3.selectAll("div.state")
		.on("mouseover",function(){
			d3.selectAll("circle."+this.classList[1])
				.style("fill","paleVioletRed");
		})
		.on("mouseout",function(){
			d3.selectAll("circle."+this.classList[1])
				.style("fill","lightBlue");
		});


	force.start();
};

function tick() {
  node.attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; })

  link.attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });
	  
  label.attr("transform", function(d) {
    return "translate(" + d.x + "," + d.y + ")";
  });
};

$(".confBtn").click(function(){
	url = confURLs[$(this).attr("id")];
	loadConflict(url);
});


});
</script>
	
</head>

<body>
<div class="container">
	<div class="confBtns">
		<div class="confBtn" id="SyriaIraq" href="javascript:void">Syria Iraq</div>
		<div class="confBtn" id="Garrison" href="javascript:void">Garrison Diversion Unit</div>
		<div class="confBtn" id="Prisoners" href="javascript:void">Prisoners Dilemma</div>
	</div>

	<svg class="layout force">
		<defs>
			<marker id="arrow-head" viewBox="0 -5 18 10" refX="18" refY="0" markerWidth="15" markerHeight="10" orient="auto" color="inherit"><path d="M 0,-5  L 10,0  L 0,5"></path></marker>
	</svg>
	
	<div class="stateBar"></div>


</div>	
</body>
</html>